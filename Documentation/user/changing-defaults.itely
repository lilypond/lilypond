@c -*- coding: latin-1; mode: texinfo; -*-
@node Changing defaults
@chapter Changing defaults


The purpose of LilyPond's design is to provide the finest output
quality as a default.  Nevertheless, it may happen that you need to
change this default layout.  The layout is controlled through a large
number of proverbial ``knobs and switches.''  This chapter does not
list each and every knob.  Rather, it outlines what groups of controls
are available and explains how to lookup which knob to use for a
certain effect.


@cindex Program reference

The controls available for tuning are described in a separate
document, the
@iftex
Program reference
@end iftex
@ifnottex
@ref{Top,Program reference,,lilypond-internals}.
@end ifnottex
manual.  That manual
lists all different variables, functions and options available in
LilyPond.  It is written as a HTML document, which is available
@uref{http://@/lilypond@/.org/@/doc/@/v2.4/@/Documentation/@/user/@/out@/-www/@/lilypond@/-internals/,on@/-line},
but is also included with the LilyPond documentation package.

There are three areas where the default settings may be changed:

@itemize @bullet
@item
Output: changing the appearance of individual
objects.  For example, changing stem directions, or the location of
subscripts.
  
@item
Context: changing aspects of the translation from music events to
notation.  For example, giving each staff a separate time signature. 
  
@item
Global layout: changing the appearance of the spacing, line
breaks and page dimensions.
@end itemize

Then, there are separate systems for typesetting text (like
@emph{ritardando}) and selecting different fonts.  This chapter also
discusses these.

Internally, LilyPond uses Scheme (a LISP dialect) to provide
infrastructure.  Overriding layout decisions in effect accesses the
program internals, which requires Scheme input.  Scheme elements are
introduced in a @code{.ly} file with the hash mark
@code{#}.@footnote{@ref{Scheme tutorial} contains a a short tutorial
on entering numbers, lists, strings and symbols in Scheme.}


@menu
* Interpretation contexts::     
* The \override command::       
* Fonts::                       
* Text markup::                 
* Global layout::               
* File structure::              
@end menu

 
@node Interpretation contexts
@section Interpretation contexts

When music is printed, a lot of notation elements must be added to the
input, which is often bare bones.  For example, compare the input and
output of the following example:

@lilypond[quote,verbatim,relative=2,fragment]
cis4 cis2. g4
@end lilypond

The input is rather sparse, but in the output, bar lines, accidentals,
clef, and time signature are added.  LilyPond @emph{interprets} the
input.  During this step, the musical information is inspected in time
order, similar to reading a score from left to right.  While reading,
the program remembers where measure boundaries are, and what pitches
need explicit accidentals.  This information can be presented on
several levels.  For example, the effect of an accidental is limited
to a single stave, while a bar line must be synchronized across the
entire score.

Within LilyPond, these rules and bits of information are grouped in
so-called Contexts.  Examples of context are @context{Voice},
@context{Staff}, and @context{Score}.  They are hierarchical, for
example, a @context{Staff} can contain many @context{Voice}s, and a
@context{Score} can contain many @context{Staff} contexts.

Each context has the responsibility for enforcing some notation rules,
creating some notation objects and maintaining the associated
properties.  So, the synchronization of bar lines is handled at
@context{Score} context.  The @context{Voice} may introduce an
accidentals and then the @context{Staff} context maintains the rule to
show or suppress the accidental for the remainder of the measure.

For simple scores, contexts are created implicitly, and you need not
be aware of them.  For larger pieces, such as piano music, they must be
created explicitly to make sure that you get as many staves as you
need, and that they are in the correct order.  For typesetting pieces
with specialized notation, it can be useful to modify existing or
define new contexts.


Full description of all available contexts is in the program
reference, see
@ifhtml
@internalsref{Contexts}.
@end ifhtml
@ifnothtml 
Translation @arrow{} Context.
@end ifnothtml

@c [TODO: describe propagation]


@menu
* Creating contexts::           
* Changing context properties on the fly::  
* Modifying context plug-ins::  
* Layout tunings within contexts::  
* Changing context default settings::  
* Defining new contexts::      
@end menu

@node Creating contexts
@subsection Creating contexts

For scores with only one voice and one staff, correct contexts are
created automatically.  For more complex scores, it is necessary to
create them by hand.  There are three commands which do this.

The easiest command is @code{\new}, and it also the quickest to type.
It is prepended to a music expression, for example

@cindex @code{\new}
@cindex new contexts
@cindex Context, creating

@example
\new @var{type} @var{music expression}
@end example

@noindent
where @var{type} is a context name (like @code{Staff} or
@code{Voice}).  This command creates a new context, and starts
interpreting @var{music expression} with that.

A practical application of @code{\new} is a score with many
staves.  Each part that should be on its own staff, is preceded with 
@code{\new Staff}.

@lilypond[quote,verbatim,relative=2,raggedright,fragment]
<< \new Staff { c4 c }
   \new Staff { d4 d }
>>
@end lilypond

@cindex @code{\context}

Like @code{\new}, the @code{\context} command also directs a music
expression to a context object, but gives the context an extra name.  The
syntax is

@example
\context @var{type} = @var{id} @var{music}
@end example

This form will search for an existing context of type @var{type}
called @var{id}.  If that context does not exist yet, it is created.
This is useful if the context is referred to later on.  For example, when
setting lyrics the melody is in a named context

@example
\context Voice = "@b{tenor}" @var{music}
@end example

@noindent
so the texts can be properly aligned to its notes,

@example
\new Lyrics \lyricsto "@b{tenor}" @var{lyrics} 
@end example

@noindent

Another possibility is funneling two different music expressions into
one context.  In the following example, articulations and notes are
entered separately,

@example
music = @{ c4 c4 @}
arts = @{ s4-. s4-> @}
@end example

They are combined by sending both to the same @context{Voice} context,

@example
<< \new Staff \context Voice = "A" \music
   \context Voice = "A" \arts
>>
@end example
@lilypond[quote,raggedright]
music = { c4 c4 }
arts = { s4-. s4-> }
\relative c'' <<
  \new Staff \context Voice = "A" \music
  \context Voice = "A" \arts
>>
@end lilypond

With this mechanism, it is possible to define an Urtext (original
edition), with the option put several distinct articulations on the
same notes.

@cindex @code{\context}
@cindex creating contexts

The third command for creating contexts is
@example
\context @var{type} @var{music}
@end example


@noindent
This is similar to @code{\context} with @code{= @var{id}}, but matches
any context of type @var{type}, regardless of its given name.

This variant is used with music expressions that can be interpreted at
several levels.  For example, the @code{\applyoutput} command (see
@ref{Running a function on all layout objects}).  Without an explicit
@code{\context}, it is usually is applied to @context{Voice}

@example
\applyoutput #@var{function}   % apply to Voice
@end example

To have it interpreted at the @context{Score} or @context{Staff} level use
these forms

@example
\context Score \applyoutput #@var{function}
\context Staff \applyoutput #@var{function}
@end example


@node Changing context properties on the fly
@subsection Changing context properties on the fly

@cindex properties
@cindex @code{\set}
@cindex changing properties

Each context can have different @emph{properties}, variables contained
in that context.  They can be changed during the interpretation step.
This is achieved by inserting the @code{\set} command in the music,

@example
\set @var{context}.@var{prop} = #@var{value}
@end example

For example,
@lilypond[quote,verbatim,relative=2,fragment]
R1*2 
\set Score.skipBars = ##t
R1*2
@end lilypond

This command skips measures that have no notes.  The result is that
multi rests are condensed.  The value assigned is a Scheme object.  In
this case, it is @code{#t}, the boolean True value.

If the @var{context} argument is left out, then the current bottom-most
context (typically @context{ChordNames}, @context{Voice}, or
@context{Lyrics}) is used.  In this example,

@lilypond[quote,verbatim,relative=2,fragment]
c8 c c c
\set autoBeaming = ##f
c8 c c c
@end lilypond

@noindent
the @var{context} argument to @code{\set} is left out, so automatic
beaming is switched off in the current @internalsref{Voice}.

Contexts are hierarchical, so if a bigger context was specified, for
example @context{Staff}, then the change would also apply to all
@context{Voice}s in the current stave.  The change is applied
`on-the-fly', during the music, so that the setting only affects the
second group of eighth notes.

@cindex @code{\unset} 

There is also an @code{\unset} command,
@example
\unset @var{context}.@var{prop}
@end example

@noindent
which removes the definition of @var{prop}.  This command removes
the definition only if it is set in @var{context}, so

@example
\set Staff.autoBeaming = ##f
@end example

@noindent
introduces a property setting at @code{Staff} level.  The setting also
applies to the current @code{Voice}.  However,

@example
\unset Voice.autoBeaming
@end example

@noindent
does not have any effect.  To cancel this setting, the @code{\unset}
must be specified on the same level as the original @code{\set}.  In
other words, undoing the effect of @code{Staff.autoBeaming = ##f}
requires
@example
\unset Staff.autoBeaming
@end example

Like @code{\set}, the @var{context} argument does not have to be
specified for a bottom context, so the two statements

@example
\set Voice.autoBeaming = ##t 
\set autoBeaming = ##t 
@end example 

@noindent
are equivalent.


@cindex \once
Settings that should only apply to a single time-step can be entered
with @code{\once}, for example in

@lilypond[quote,verbatim,relative=2,fragment]
c4
\once \set fontSize = #4.7
c4
c4
@end lilypond

the property @code{fontSize} is unset automatically after the second
note.

A full description of all available context properties is in the
program reference, see
@ifhtml
@internalsref{Tunable context properties}.
@end ifhtml
@ifnothtml
Translation @arrow{} Tunable context properties.
@end ifnothtml


@node Modifying context plug-ins
@subsection Modifying context plug-ins

Notation contexts (like Score and Staff) not only store properties,
they also contain plug-ins, called ``engravers'' that create notation
elements.  For example, the Voice context contains a
@code{Note_head_engraver} and the Staff context contains a
@code{Key_signature_engraver}.

For a full a description of each plug-in, see 
@ifhtml
@internalsref{Engravers}.
@end ifhtml
@ifnothtml
Program reference @arrow Translation @arrow{} Engravers.
@end ifnothtml
Every context described in
@ifhtml
@internalsref{Contexts}
@end ifhtml
@ifnothtml 
Program reference @arrow Translation @arrow{} Context.
@end ifnothtml
lists the engravers used for that context.


It can be useful to shuffle around these plug-ins.  This is done by
starting a new context, with @code{\new} or @code{\context}, and
modifying it like this, 

@example
\new @var{context} \with @{
  \consists @dots{}
  \consists @dots{}
  \remove @dots{}
  \remove @dots{}
  @emph{etc.}
@}
@emph{..music..}
@end example

@noindent
where the @dots{} should be the name of an engraver.  Here is a simple
example which removes @code{Time_signature_engraver} and
@code{Clef_engraver} from a @code{Staff} context,

@lilypond[quote,relative=1,verbatim,fragment]
<< \new Staff {
    f2 g
  }
  \new Staff \with {
     \remove "Time_signature_engraver"
     \remove "Clef_engraver"
  } {
    f2 g2
  }
>>
@end lilypond

In the second stave there are no time signature or clef symbols.  This
is a rather crude method of making objects disappear since it will affect
the entire staff.  The spacing is adversely influenced too.  A more
sophisticated methods of blanking objects is shown in @ref{Common
tweaks}.

The next example shows a practical application.  Bar lines and time
signatures are normally synchronized across the score.  This is done
by the @code{Timing_engraver}.  This plug-in keeps an administration of
time signature, location within the measure, etc.  By moving the
@code{Timing_engraver} engraver from @code{Score} to @code{Staff}
context, we can have a score where each staff has its own time
signature.

@cindex polymetric scores


@lilypond[quote,relative=1,raggedright,verbatim,fragment]
\new Score \with {
  \remove "Timing_engraver"
} <<
  \new Staff \with {
    \consists "Timing_engraver"
  } {
      \time 3/4
      c4 c c c c c
  }
  \new Staff \with {
    \consists "Timing_engraver"
  } {
       \time 2/4
       c4 c c c c c
  }
>>
@end lilypond


@node Layout tunings within contexts
@subsection Layout tunings within contexts

Each context is responsible for creating certain types of graphical
objects.  The settings used for printing these objects are also stored by
context.  By changing these settings, the appearance of objects can be
altered.
 
The syntax for this is

@example
\override @var{context}.@var{name} #'@var{property} = #@var{value}
@end example

Here @var{name} is the name of a graphical object, like @code{Stem} or
@code{NoteHead}, and @var{property} is an internal variable of the
formatting system (`grob property' or `layout property').  The latter is a
symbol, so it must be quoted.  The subsection @ref{Constructing a
tweak} explains what to fill in for @var{name}, @var{property}, and
@var{value}.  Here we only discuss functionality of this command.

The command

@verbatim
\override Staff.Stem #'thickness = #4.0 
@end verbatim

@noindent
makes stems thicker (the default is 1.3, with staff line thickness as a
unit).  Since the command specifies @context{Staff} as context, it only
applies to the current staff.  Other staves will keep their normal
appearance.  Here we see the command in action:

@lilypond[quote,verbatim,relative=2,fragment]
c4
\override Staff.Stem #'thickness = #4.0 
c4
c4
c4
@end lilypond

The @code{\override} command changes the definition of the @code{Stem}
within the current @context{Staff}.  After the command is interpreted
all stems are thickened.

Analogous to @code{\set}, the @var{context} argument may be left out,
causing it to default to @context{Voice}, and adding @code{\once} applies
the change during one timestep only 

@lilypond[quote,fragment,verbatim,relative=2]
c4
\once \override Stem #'thickness = #4.0 
c4
c4 
@end lilypond

The @code{\override} must be done before the object is
started.  Therefore, when altering @emph{Spanner} objects, like slurs or
beams, the @code{\override} command must be executed at the moment when
the object is created.  In this example,


@lilypond[quote,fragment,verbatim,relative=2]
\override Slur #'thickness = #3.0
c8[( c
\override Beam #'thickness = #0.6
c8 c]) 
@end lilypond

@noindent
the slur is fatter but the beam is not.  This is because the command for
@code{Beam} comes after the Beam is started.  Therefore it has no effect.

Analogous to @code{\unset}, the @code{\revert} command for a context
undoes a @code{\override} command; like with @code{\unset}, it only
affects settings that were made in the same context.  In other words, the
@code{\revert} in the next example does not do anything.

@example
\override Voice.Stem #'thickness = #4.0
\revert Staff.Stem #'thickness
@end example




@seealso

Internals: @internalsref{OverrideProperty}, @internalsref{RevertProperty},
@internalsref{PropertySet}, @internalsref{Backend}, and
@internalsref{All layout objects}.


@refbugs

The back-end is not very strict in type-checking object properties.
Cyclic references in Scheme values for properties can cause hangs
or crashes, or both.


@node Changing context default settings
@subsection Changing context default settings

The adjustments of the previous subsections (@ref{Changing context
properties on the fly}, @ref{Modifying context plug-ins} and
@ref{Layout tunings within contexts}) can also be entered separate
from the music, in the @code{\layout} block,

@example
\layout @{
  @dots{}
  \context @{
    \Staff

    \set fontSize = #-2
    \override Stem #'thickness = #4.0
    \remove "Time_signature_engraver"
  @}
@}
@end example

Here
@example
\Staff
@end example

@noindent
takes the existing definition for context @context{Staff} from the
identifier @code{\Staff}. 

The statements
@example
\set fontSize = #-2
\override Stem #'thickness = #4.0
\remove "Time_signature_engraver"
@end example

@noindent
affect all staves in the score.

Other contexts can be modified analogously.

The @code{\set} keyword is optional within the @code{\layout} block, so

@example
\context @{
  @dots{}
  fontSize = #-2
@}
@end example

@noindent
will also work.



@refbugs

It is not possible to collect context changes in a variable, and apply
them to one @code{\context} definition by referring to that variable.


@node Defining new contexts
@subsection Defining new contexts

Specific contexts, like @context{Staff} and @code{Voice}, are made of
simple building blocks, and it is possible to compose engraver
plug-ins in different combinations, thereby creating new types of
contexts.

The next example shows how to build a different type of
@context{Voice} context from scratch.  It will be similar to
@code{Voice}, but print centered slash noteheads only.  It can be used
to indicate improvisation in Jazz pieces,

@lilypond[quote,raggedright]
\layout { \context {
  \name ImproVoice
  \type "Engraver_group_engraver"
  \consists "Note_heads_engraver"
  \consists "Text_engraver"
  \consists Pitch_squash_engraver
  squashedPosition = #0
  \override NoteHead #'style = #'slash
  \override Stem #'transparent = ##t
  \alias Voice
}
\context { \Staff
  \accepts "ImproVoice"
}}

\relative c'' {
  a4 d8 bes8 \new ImproVoice { c4^"ad lib" c 
   c4 c^"undress" c_"while playing :)" c } 
  a1 
}
@end lilypond


These settings are again done within a @code{\context} block inside a
@code{\layout} block,

@example
\layout @{
  \context @{
    @dots{}
  @}
@}
@end example

In the following discussion, the example input shown should go on the
@dots{} in the previous fragment.

First, name the context gets a name.  Instead of @context{Voice} it
will be called @context{ImproVoice},

@example
\name ImproVoice
@end example

Since it is similar to the @context{Voice}, we want commands that work
on (existing) @context{Voice}s to remain working.  This is achieved by
giving the new context an alias @context{Voice},

@example
\alias Voice
@end example

The context will print notes, and instructive texts

@example
\consists Note_heads_engraver
\consists Text_engraver
@end example

but only on the center line,

@example
\consists Pitch_squash_engraver
squashedPosition = #0
@end example

The @internalsref{Pitch_squash_engraver} modifies note heads (created
by @internalsref{Note_heads_engraver}) and sets their vertical
position to the value of @code{squashedPosition}, in this case@tie{}@code{0},
the center line.

The notes look like a slash, without a stem,

@example
\override NoteHead #'style = #'slash
\override Stem #'transparent = ##t
@end example


All these plug-ins have to cooperate, and this is achieved with a
special plug-in, which must be marked with the keyword @code{\type}.
This should always be @internalsref{Engraver_group_engraver},

@example
\type "Engraver_group_engraver"
@end example

Putting together, we get

@example
\context @{
  \name ImproVoice
  \type "Engraver_group_engraver"
  \consists "Note_heads_engraver"
  \consists "Text_engraver"
  \consists Pitch_squash_engraver
  squashedPosition = #0
  \override NoteHead #'style = #'slash
  \override Stem #'transparent = ##t
  \alias Voice
@}
@end example

Contexts form hierarchies.  We want to hang the @context{ImproVoice}
under @context{Staff}, just like normal @code{Voice}s.  Therefore, we
modify the @code{Staff} definition with the @code{\accepts}
command,@footnote{The opposite of @code{\accepts} is @code{\denies},
which is sometimes needed when reusing existing context definitions.}



@example
\context @{
  \Staff
  \accepts ImproVoice    
@}
@end example

Putting both into a @code{\layout} block, like

@example
\layout @{
  \context @{
    \name ImproVoice
    @dots{}
  @}
  \context @{
    \Staff
    \accepts "ImproVoice"
  @}
@}
@end example

Then the output at the start of this subsection can be entered as

@example
\relative c'' @{
  a4 d8 bes8
  \new ImproVoice @{
    c4^"ad lib" c 
    c4 c^"undress"
    c c_"while playing :)"
  @}
  a1
@}
@end example
  

    

@node The \override command
@section The \override command

In the previous section, we have already touched on a command that
changes layout details, the @code{\override} command.  In this section,
we will look at in more detail how to use the command in practice.
First, we will give a a few versatile commands, which are sufficient
for many situations.  The next section will discuss general use of
@code{\override}.


@menu
* Common tweaks::               
* Constructing a tweak::        
* Navigating the program reference::  
* Layout interfaces::           
* Determining the grob property::  
* Difficult tweaks::            
@end menu



@node Common tweaks
@subsection Common tweaks

Some overrides are so common that predefined commands are provided as
a short-cut, for example, @code{\slurUp} and @code{\stemDown}.  These
commands are described in
@ifhtml
the
@end ifhtml
@ref{Notation manual}, under the sections for slurs and stems
respectively.

The exact tuning possibilities for each type of layout object are
documented in the program reference of the respective
object.  However, many layout objects share properties, which can be
used to apply generic tweaks.  We mention a few of these:

@itemize @bullet
@item The @code{extra-offset} property, which
@cindex @code{extra-offset}
has a pair of numbers as value, moves around objects in the printout.
The first number controls left-right movement; a positive number will
move the object to the right.  The second number controls up-down
movement; a positive number will move it higher.  The units of these
offsets are staff-spaces.  The @code{extra-offset} property is a
low-level feature: the formatting engine is completely oblivious to
these offsets.

In the following example, the second fingering is moved a little to
the left, and 1.8 staff space downwards:

@cindex setting object properties

@lilypond[quote,fragment,relative=1,verbatim]
\stemUp
f-5
\once \override Fingering
    #'extra-offset = #'(-0.3 . -1.8) 
f-5
@end lilypond

@item
Setting the @code{transparent} property will cause an object to be printed
in `invisible ink': the object is not printed, but all its other
behavior is retained.  The object still takes up space, it takes part in
collisions, and slurs, and ties and beams can be attached to it.

@cindex transparent objects
@cindex removing objects
@cindex hiding objects
@cindex invisible objects
The following example demonstrates how to connect different voices
using ties.  Normally, ties only connect two notes in the same
voice.  By introducing a tie in a different voice,

@lilypond[quote,fragment,relative=2]
<< {
  b8~ b8\noBeam
} \\ {
  b[ g8]
} >>
@end lilypond

@noindent
and blanking the first up-stem in that voice, the tie appears to cross
voices:

@lilypond[quote,fragment,relative=2,verbatim]
<< {
  \once \override Stem #'transparent = ##t
  b8~ b8\noBeam
} \\ {
  b[ g8]
} >>
@end lilypond

@item
The @code{padding} property for objects with
@cindex @code{padding}
@code{side-position-interface} can be set to increase distance between
symbols that are printed above or below notes.  We only give an
example; a more elaborate explanation is in @ref{Constructing a
tweak}:

@lilypond[quote,fragment,relative=1,verbatim]
c2\fermata
\override Script #'padding = #3
b2\fermata
@end lilypond

@end itemize

More specific overrides are also possible.  The next section
discusses in depth how to figure out these statements for yourself.


@node Constructing a tweak
@subsection Constructing a tweak

The general procedure of changing output, that is, entering
a command like

@example
\override Voice.Stem #'thickness = #3.0
@end example

@noindent
means that we have to determine these bits of information:

@itemize
@item the context: here @context{Voice}.
@item the layout object: here @code{Stem}.
@item the layout property: here @code{thickness}
@item a sensible value: here @code{3.0}
@end itemize  


@cindex internal documentation
@cindex finding graphical objects
@cindex graphical object descriptions 
@cindex tweaking
@cindex @code{\override}
@cindex @code{\set}
@cindex internal documentation

We demonstrate how to glean this information from the notation manual
and the program reference.

@node Navigating the program reference
@subsection Navigating the program reference

Suppose we want to move the fingering indication in the fragment
below:

@lilypond[quote,fragment,relative=2,verbatim]
c-2
\stemUp
f
@end lilypond

If you visit the documentation on fingering instructions (in
@ref{Fingering instructions}), you will notice that there is written:

@quotation
@seealso

Program reference: @internalsref{FingerEvent} and @internalsref{Fingering}.

@end quotation



This fragment points to two parts of the program reference: a page
on @code{FingerEvent} and on @code{Fingering}.

The page on @code{FingerEvent} describes the properties of the music
expression for the input @code{-2}.  The page contains many links
forward.  For example, it says

@quotation
Accepted by: @internalsref{Fingering_engraver},
@end quotation 

@noindent
That link brings us to the documentation for the Engraver, the
plug-in, which says

@quotation
This engraver creates the following layout objects: @internalsref{Fingering}.
@end quotation

In other words, once the @code{FingerEvent}s are interpreted, the
@code{Fingering_engraver} plug-in will process them.
The @code{Fingering_engraver} is also listed to create
@internalsref{Fingering} objects,


Lo and behold, that is also the
second bit of information listed under @b{See also} in the Notation
manual.  By clicking around in the program reference, we can follow the
flow of information within the program, either forward (like we did
here), or backwards, following links like this:

@itemize @bullet

@item @internalsref{Fingering}:
@internalsref{Fingering} objects are created by:
@b{@internalsref{Fingering_engraver}}

@item @internalsref{Fingering_engraver}:
Music types accepted: @b{@internalsref{fingering-event}}

@item @internalsref{fingering-event}:
Music event type @code{fingering-event} is in Music expressions named
@b{@internalsref{FingerEvent}}
@end itemize

This path goes against the flow of information in the program: it
starts from the output, and ends at the input event.

The program reference can also be browsed like a normal document.  It
contains a chapter on
@ifhtml
@internalsref{Music definitions},
@end ifhtml
@ifnothtml
@code{Music definitions}
@end ifnothtml
on @internalsref{Translation}, and the @internalsref{Backend}.  Every
chapter lists all the definitions used, and all properties that may be
tuned.

 
@node Layout interfaces
@subsection Layout interfaces

@cindex interface, layout
@cindex layout interface

The HTML page which we found in the previous section, describes the
layout object called @internalsref{Fingering}.  Such an object is a
symbol within the score.  It has properties, which store numbers (like
thicknesses and directions), but also pointers to related objects.  A
layout object is also called @emph{grob},
@cindex grob
which is short for Graphical Object.


The page for @code{Fingering} lists the definitions for the
@code{Fingering} object.  For example, the page says

@quotation
@code{padding} (dimension, in staff space):
  
@code{0.6}
@end quotation

@noindent
which means that the number will be kept at a distance of at least 0.6
of the note head.


Each layout object may have several functions as a notational or
typographical element.  For example, the Fingering object
has the following aspects

@itemize @bullet
@item
Its size is independent of the horizontal spacing, unlike slurs or beams.

@item
It is a piece of text.  Granted, it is usually a very short text.

@item
That piece of text is typeset with a font, unlike slurs or beams.

@item
Horizontally, the center of the symbol should be aligned to the
center of the notehead.

@item
Vertically, the symbol is placed next to the note and the staff.

@item
The vertical position is also coordinated with other super and subscript
symbols.
@end itemize

Each of these aspects is captured in a so-called @emph{interface},
which are listed on the @internalsref{Fingering} page at the bottom

@quotation
This object supports the following interfaces:
@internalsref{item-interface},
@internalsref{self-alignment-interface},
@internalsref{side-position-interface}, @internalsref{text-interface},
@internalsref{text-script-interface}, @internalsref{font-interface},
@internalsref{finger-interface}, and @internalsref{grob-interface}.
@end quotation

Clicking any of the links will take you to the page of the respective
object interface.  Each interface has a number of properties.  Some of
them are not user-serviceable (``Internal properties''), but others
are.

We have been talking of `the' @code{Fingering} object, but actually it
does not amount to much.  The initialization file
@file{scm/@/define@/-grobs@/.scm} shows the soul of the `object',

@example
(Fingering
  . ((print-function . ,Text_interface::print)
     (padding . 0.6)
     (staff-padding . 0.6)
     (self-alignment-X . 0)
     (self-alignment-Y . 0)
     (script-priority . 100)
     (font-encoding . number)
     (font-size . -5)
     (meta . ((interfaces . (finger-interface font-interface
                             text-script-interface text-interface
                             side-position-interface
                             self-alignment-interface
                             item-interface))))))
@end example

@noindent
As you can see, the @code{Fingering} object is nothing more than a
bunch of variable settings, and the webpage in the Program Reference
is directly generated from this definition.

@node Determining the grob property
@subsection Determining the grob property


Recall that we wanted to change the position of the @b{2} in 

@lilypond[quote,fragment,relative=2,verbatim]
c-2
\stemUp
f
@end lilypond

Since the @b{2} is vertically positioned next to its note, we have to
meddle with the interface associated with this positioning.  This is
done using @code{side-position-interface}.  The page for this interface 
says

@quotation
@code{side-position-interface}

Position a victim object (this one) next to other objects (the
support).  The property @code{direction} signifies where to put the
victim object relative to the support (left or right, up or down?)
@end quotation

@cindex padding
@noindent
below this description, the variable @code{padding} is described as

@quotation
@table @code
@item padding
(dimension, in staff space)

Add this much extra space between objects that are next to each other. 
@end table
@end quotation

By increasing the value of @code{padding}, we can move away the
fingering.  The following command inserts 3 staff spaces of white
between the note and the fingering:
@example
\once \override Voice.Fingering #'padding = #3
@end example

Inserting this command before the Fingering object is created,
i.e., before @code{c2}, yields the following result:

@lilypond[quote,relative=2,fragment,verbatim]
\once \override Voice.Fingering #'padding = #3
c-2
\stemUp
f
@end lilypond


In this case, the context for this tweak is @context{Voice}.  This
fact can also be deduced from the program reference, for the page for
the @internalsref{Fingering_engraver} plug-in says

@quotation
Fingering_engraver is part of contexts: @dots{} @b{@internalsref{Voice}}
@end quotation

@node Difficult tweaks
@subsection Difficult tweaks

There are two classes of difficult adjustments.  First, when there are
several of the same objects at one point, and you want to adjust only
one.  For example, if you want to change only one note head in a chord.

In this case, the @code{\applyoutput} function must be used.  The
next example defines a Scheme function @code{set-position-font-size}
that sets the @code{font-size} property, but only  
on objects that have @internalsref{note-head-interface} and are at the
right Y-position.

@lilypond[quote,verbatim]
#(define ((set-position-font-size pos size) grob origin current)
  (let*
      ((interfaces (ly:grob-property grob 'interfaces))
       (position (ly:grob-property grob 'staff-position)))
   (if (and
        ; is this a note head?
        (memq 'note-head-interface interfaces)

        ; is the Y coordinate right?
        (= pos position))

      ; then do it.
      (set! (ly:grob-property grob 'font-size) size))))

\relative {
  c
  \applyoutput #(set-position-font-size -2 4)
  <c e g>
}
@end lilypond

@noindent
A similar technique can be used for accidentals.  In that case, the
function should check for @code{accidental-interface}.

Another difficult adjustment is the appearance of spanner objects,
such as slur and tie.  Initially, only one of these objects is created,
and they can be adjust with the normal mechanism.  However, in some
cases the spanners cross line breaks.  If this happens, these objects
are cloned.  A separate object is created for every system that it is
in.  These are clones of the original object and inherit all
properties, including @code{\override}s.

In other words, an @code{\override} always affects all pieces of a
broken spanner.  To change only one part of a spanner at a line break,
it is necessary to hook into the formatting process.  The
@code{after-line-breaking-callback} property contains the Scheme procedure
that is called after line breaks have been determined, and layout
objects have been split over different systems.

In the following example, we define a procedure
@code{my-callback}.  This procedure
 
@itemize @bullet
@item
determines if we have been split across line breaks
@item
if yes, retrieves all the split objects
@item
checks if we are the last of the split objects
@item
if yes, it sets @code{extra-offset}.
@end itemize

This procedure is installed into @internalsref{Tie}, so the last part
of broken tie is translated up.


@lilypond[quote,verbatim,raggedright]
#(define (my-callback grob)
  (let* (
         ; have we been split? 
         (orig (ly:grob-original grob))

         ; if yes, get the split pieces (our siblings)
         (siblings (if (ly:grob? orig)
                     (ly:spanner-broken-into orig) '() )))

   (if (and (>= (length siblings) 2)
             (eq? (car (last-pair siblings)) grob))
     (ly:grob-set-property! grob 'extra-offset '(-2 . 5)))))

\relative c'' { 
  \override Tie #'after-line-breaking-callback =
  #my-callback
  c1 ~ \break c2 ~ c
}
@end lilypond

@noindent
When applying this trick, the new @code{after-line-breaking-callback}
should also call the old @code{after-line-breaking-callback}, if there
is one.  For example, if using this with @code{Slur},
@code{Slur::after_line_breaking} should also be called.

@node Fonts
@section Fonts

@menu
* Selecting font sizes::        
* Font selection::              
@end menu



@node Selecting font sizes
@subsection Selecting font sizes


The easiest method of setting the font size of any context, is by
setting the @code{fontSize} property.

@lilypond[quote,fragment,relative=1,verbatim]
c8
\set fontSize = #-4
c f
\set fontSize = #3
g
@end lilypond

@noindent
It does not change the size of variable symbols, such as beams or
slurs.

Internally, the @code{fontSize} context property will cause
@code{font-size} property to be set in all layout objects.  The value
of @code{font-size} is a number indicating the size relative to the
standard size for the current staff height.  Each step up is an
increase of approximately 12% of the font size.  Six steps is exactly a
factor two.  The Scheme function @code{magstep} converts a
@code{font-size} number to a scaling factor.

@lilypond[quote,fragment,relative=1,verbatim]
c8
\override NoteHead #'font-size = #-4
c f
\override NoteHead #'font-size = #3
g
@end lilypond

LilyPond has fonts in different design sizes.  The music fonts for
smaller sizes are chubbier, while the text fonts are relatively wider.
Font size changes are achieved by scaling the design size that is
closest to the desired size.  The standard font size (for
@code{font-size} equals 0), depends on the standard staff height.  For
a 20 pt staff, a 10pt font is selected.

The @code{font-size} mechanism does not work for fonts selected
through @code{font-name}.  These may be scaled with
@code{font-magnification}.  The @code{font-size} property can only be
set on layout objects that use fonts; these are the ones supporting
@internalsref{font-interface} layout interface.

@refcommands

The following commands set @code{fontSize} for the current voice:

@cindex @code{\tiny}
@code{\tiny}, 
@cindex @code{\small}
@code{\small}, 
@cindex @code{\normalsize}
@code{\normalsize}.



@cindex magnification
@cindex cue notes


@node Font selection
@subsection Font selection



@cindex font selection
@cindex font magnification
@cindex @code{font-interface}

By setting the object properties described below, you can select a
font from the preconfigured font families.  LilyPond has default
support for the feta music fonts and @TeX{}'s Computer Modern text
fonts.


@itemize @bullet
@item @code{font-encoding}
is a symbol that sets layout of the glyphs.  Choices include @code{ec}
for @TeX{} EC font encoding, @code{fetaBraces} (for piano staff
braces), @code{fetaMusic} (the standard music font, including ancient
glyphs), @code{fetaDynamic} (for dynamic signs) and @code{fetaNumber}
for the number font.

@item @code{font-family}
is a symbol indicating the general class of the typeface.  Supported are
@code{roman} (Computer Modern), @code{sans}, and @code{typewriter}.
  
@item @code{font-shape}
is a symbol indicating the shape of the font, there are typically
several font shapes available for each font family.  Choices are
@code{italic}, @code{caps}, and @code{upright}.

@item @code{font-series}
is a symbol indicating the series of the font.  There are typically several
font series for each font family and shape.  Choices are @code{medium}
and @code{bold}. 

@end itemize

Fonts selected in the way sketched above come from a predefined style
sheet.

 The font used for printing a object can be selected by setting
@code{font-name}, e.g.
@example
\override Staff.TimeSignature
    #'font-name = #"cmr17"
@end example

@noindent
Any font can be used, as long as it is available to @TeX{}.  Possible
fonts include foreign fonts or fonts that do not belong to the
Computer Modern font family.  The size of fonts selected in this way
can be changed with the @code{font-magnification} property.  For
example, @code{2.0} blows up all letters by a factor 2 in both
directions.

@cindex font size
@cindex font magnification



@seealso

Init files: @file{ly/@/declarations@/-init@/.ly} contains hints how new
fonts may be added to LilyPond.



@node Text markup
@section Text markup
@cindex text markup
@cindex markup text


@cindex typeset text

The internal mechanism to typeset texts is accessed with the keyword
@code{\markup}.  Within markup mode, you can enter texts similar to
lyrics.  They are simply entered, while commands use the backslash @code{\}.
@cindex markup

@lilypond[quote,verbatim,fragment,relative=1]
c1^\markup { hello }
c1_\markup { hi there }
c1^\markup { hi \bold there, is \italic anyone home? }
@end lilypond

@cindex font switching

The markup in the example demonstrates font switching commands.  The
command @code{\bold} and @code{\italic} apply to the first following 
word only; enclose a set of texts with braces to apply a command
to more words:
@example
\markup @{ \bold @{ hi there @} @}
@end example

@noindent
For clarity, you can also do this for single arguments, e.g.

@example
\markup @{ is \italic @{ anyone @} home @}
@end example

@cindex font size, texts


In markup mode you can compose expressions, similar to mathematical
expressions, XML documents, and music expressions.  The braces group
notes into horizontal lines.  Other types of lists also exist: you can
stack expressions grouped with @code{<} and @code{>} vertically with
the command @code{\column}.  Similarly, @code{\center-align} aligns
texts by their center lines:

@lilypond[quote,verbatim,fragment,relative=1]
c1^\markup { \column < a bbbb c > }
c1^\markup { \center-align < a bbbb c > }
c1^\markup { \line < a b c > }
@end lilypond


Markups can be stored in variables, and these variables
may be attached to notes, like
@example
allegro = \markup @{ \bold \large @{ Allegro @} @}
 @{ a^\allegro b c d @}
@end example


Some objects have alignment procedures of their own, which cancel out
any effects of alignments applied to their markup arguments as a
whole.  For example, the @internalsref{RehearsalMark} is horizontally
centered, so using @code{\mark \markup @{ \left-align .. @}} has no
effect.

Similarly, for moving whole texts over notes with
@code{\raise}, use the following trick:
@lilypond[quote,verbatim]
{
  c'^\markup { \raise #0.5 not-raised }
  c'^\markup { "" \raise #0.5 raised }
}
@end lilypond

On the second note, the text @code{raised} is moved relative to the
empty string @code{""} which is not visible.  Alternatively, complete
objects can be moved with layout properties such as @code{padding} and
@code{extra-offset}.




@seealso

Init files: @file{scm/@/new@/-markup@/.scm}.


@refbugs

No kerning or generation of ligatures is only done when the by @TeX{}
backend is used.  In this case, LilyPond does not account for them so
texts will be spaced slightly too wide.

Syntax errors for markup mode are confusing.


@menu
* Text encoding::               
* Nested scores::               
* Overview of text markup commands::  
@end menu

@node Text encoding
@subsection Text encoding

Texts can be entered in different encodings.  The encoding of the
file can be set with @code{\encoding}.

@example
\encoding "latin1"
@end example

This command may be placed anywhere in the input file.  The current
encoding is passed as an extra argument to @code{\markup} commands,
and is passed similarly to lyric syllables.

If no @code{\encoding} has been specified, then the encoding is taken
from the @code{\layout} block (or @code{\paper}, if @code{\layout}
does not specify encoding).  The variable @code{inputencoding} may be
set to a string or symbol specifying the encoding, e.g.

@example
\layout @{
  inputencoding = "latin1"
@} 
@end example

Normal strings, are unaffected by @code{\encoding}.  This means that
the following will usually not produce `Baﬂtuba' in the title.

@example
\header @{
  title = "Grazing cow"
  instrument = "Baﬂtuba"
@}
@end example

@noindent
Rather, you should say
@example
instrument = \markup @{ Baﬂtuba @}
@end example

@noindent
or set @code{inputencoding} in the @code{\paper} block. 

There is a special encoding, called @code{TeX}.  This encoding does not
reencode text for the font used.  Rather, it tries to guess the width
of @TeX{} commands, such as @code{\"}.  Strings encoded with @code{TeX}
are passed to the output back-end verbatim.

@cindex encoding
@cindex @code{\encoding}
@cindex inputencoding
@cindex @TeX{} commands in strings


@node Nested scores
@subsection Nested scores

It is possible to nest music inside markups, by adding a @code{\score}
block to markup expression.  Such a score must contain a @code{\layout}
block.

@lilypond[quote,verbatim,raggedright]
\relative {
  c4 d^\markup {
    \score {
      \relative { c4 d e f }
      \layout { }
    }
  }
  e f
}
@end lilypond
 


@node Overview of text markup commands
@subsection Overview of text markup commands

The following commands can all be used inside @code{\markup @{ @}}.

@include markup-commands.tely


@node Global layout
@section Global layout

The global layout determined by three factors: the page layout, the
line breaks, and the spacing.  These all influence each other.  The
choice of spacing determines how densely each system of music is set,
which influences where line breaks are chosen, and thus ultimately how
many pages a piece of music takes.

Globally spoken, this procedure happens in three steps: first,
flexible distances (``springs'') are chosen, based on durations.  All
possible line breaking combination are tried, and the one with the
best results --- a layout that has uniform density and requires as
little stretching or cramping as possible --- is chosen.

After spacing and linebreaking, the systems are distributed across
pages, taking into account the size of the page, and the size of the
titles.



@menu
* Setting global staff size::   
* Vertical spacing of piano staves::  
* Vertical spacing::            
* Horizontal spacing::          
* Line length::                 
* Line breaking::               
* Multiple movements::          
* Creating titles::             
* Page breaking::               
* Paper size::                  
* Page layout::                 
@end menu


@node Setting global staff size
@subsection Setting global staff size

@cindex font size, setting
@cindex staff size, setting
@cindex @code{layout} file

The Feta font provides musical symbols at eight different
sizes.  Each font is tuned for a different staff size: at a smaller size
the font becomes heavier, to match the relatively heavier staff lines.
The recommended font sizes are listed in the following table:

@quotation
@multitable @columnfractions .15 .2 .22 .2

@item @b{font name}
@tab @b{staff height (pt)}
@tab @b{staff height (mm)}
@tab @b{use}

@item feta11
@tab 11.22
@tab 3.9 
@tab pocket scores

@item feta13
@tab 12.60
@tab 4.4
@tab
 
@item feta14
@tab 14.14
@tab 5.0
@tab 

@item feta16
@tab 15.87
@tab 5.6
@tab 

@item feta18
@tab 17.82
@tab 6.3
@tab song books

@item feta20
@tab 20
@tab 7.0
@tab standard parts 

@item feta23
@tab 22.45 
@tab 7.9
@tab 

@item feta26
@tab 25.2 
@tab 8.9
@tab
@c modern rental material?

@end multitable
@end quotation

These fonts are available in any sizes.  The context property
@code{fontSize} and the layout property @code{staff-space} (in
@internalsref{StaffSymbol}) can be used to tune size for individual
staves.  The size of individual staves are relative to the global size,
which can be set in the following manner:

@example
#(set-global-staff-size 14)
@end example

@noindent
This sets the global default size to 14pt staff height, and scales all
fonts accordingly.

@seealso

This manual: @ref{Selecting font sizes}.




@node Vertical spacing of piano staves
@subsection Vertical spacing of piano staves

The distance between staves of a @internalsref{PianoStaff} cannot be
computed during formatting.  Rather, to make cross-staff beaming work
correctly, that distance has to be fixed beforehand.
 
The distance of staves in a @code{PianoStaff} is set with the
@code{forced-distance} property of the
@internalsref{VerticalAlignment} object, created in
@internalsref{PianoStaff}.

It can be adjusted as follows
@example
\new PianoStaff \with @{
  \override VerticalAlignment #'forced-distance = #7
@} @{
  ...
@}
@end example

@noindent
This would bring the staves together at a distance of 7 staff spaces,
measured from the center line of each staff.

The difference is demonstrated in the following example,
@lilypond[quote,verbatim]
\relative <<
  \new PianoStaff \with {
    \override VerticalAlignment #'forced-distance = #7
  } <<
    \new Staff { c1 }
    \new Staff { c }
  >>
  \new PianoStaff <<
    \new Staff { c }
    \new Staff { c }
  >>
>>    
@end lilypond



@refbugs

@code{forced-distance} cannot be changed per system.

@node Vertical spacing
@subsection Vertical spacing

@cindex vertical spacing
@cindex distance between staves
@cindex staff distance
@cindex between staves, distance
@cindex staves per page
@cindex space between staves

The height of each system is determined automatically.  To prevent
systems from bumping into each other, some minimum distances are set.
By changing these, you can put staves closer together, and thus put
more systems onto one page.

Normally staves are stacked vertically.  To make staves maintain a
distance, their vertical size is padded.  This is done with the
property @code{minimumVerticalExtent}.  It takes a pair of numbers, so
if you want to make it smaller from its default, then you could set

@example
\set Staff.minimumVerticalExtent = #'(-4 . 4)
@end example

@noindent
This sets the vertical size of the current staff to 4 staff spaces on
either side of the center staff line.  The argument of
@code{minimumVerticalExtent} is interpreted as an interval, where the
center line is the 0, so the first number is generally negative.  The
staff can be made larger at the bottom by setting it to @code{(-6
. 4)}. 


@seealso

Internals: Vertical alignment of staves is handled by the
@internalsref{VerticalAlignment} object.

@refbugs

@code{minimumVerticalExtent} is syntactic sugar for setting
@code{minimum-Y-extent} of the @internalsref{VerticalAxisGroup} of the
current context.  It can only be changed score wide.



@node Horizontal spacing
@subsection Horizontal Spacing

The spacing engine translates differences in durations into
stretchable distances (``springs'') of differring lengths.  Longer
durations get more space, shorter durations get less.  The shortest
durations get a fixed amount of space (which is controlled by
@code{shortest-duration-space} in the @internalsref{SpacingSpanner} object). 
The longer the duration, the more space it gets: doubling a
duration adds a fixed amount (this amount is controlled by
@code{spacing-increment}) of space to the note.

For example, the following piece contains lots of half, quarter, and
8th notes, the eighth note is followed by 1 note head width (NHW). 
The quarter note is followed by 2 NHW, the half by 3 NHW, etc.

@lilypond[quote,fragment,verbatim,relative=1]
c2 c4. c8 c4. c8 c4. c8 c8
c8 c4 c4 c4
@end lilypond

Normally, @code{spacing-increment} is set to 1.2 staff space, which is
approximately the width of a note head, and
@code{shortest-duration-space} is set to 2.0, meaning that the
shortest note gets 2.4 staff space (2.0 times the
@code{spacing-increment}) of horizontal space.  This space is counted
from the left edge of the symbol, so the shortest notes are generally
followed by one NHW of space.

If one would follow the above procedure exactly, then adding a single
32th note to a score that uses 8th and 16th notes, would widen up the
entire score a lot.  The shortest note is no longer a 16th, but a 32nd,
thus adding 1 NHW to every note.  To prevent this, the shortest
duration for spacing is not the shortest note in the score, but rather
the one which occurs most frequently.


The most common shortest duration is determined as follows: in every
measure, the shortest duration is determined.  The most common short
duration, is taken as the basis for the spacing, with the stipulation
that this shortest duration should always be equal to or shorter than
1/8th note.  The shortest duration is printed when you run
@code{lilypond} with the @code{--verbose} option.

These durations may also be customized.  If you set the
@code{common-shortest-duration} in @internalsref{SpacingSpanner}, then
this sets the base duration for spacing.  The maximum duration for this
base (normally 1/8th), is set through @code{base-shortest-duration}.

@cindex @code{common-shortest-duration}
@cindex @code{base-shortest-duration}
@cindex @code{stem-spacing-correction}
@cindex @code{spacing}

Notes that are even shorter than the commoon shortest note are
followed by a space that is proportional to their duration relative to
the common shortest note.  So if we were to add only a few 16th notes
to the example above, they would be followed by half a NHW:

@lilypond[quote,fragment,verbatim,relative=2]
c2 c4. c8 c4. c16[ c] c4. c8 c8 c8 c4 c4 c4
@end lilypond


In the introduction (see @ref{Engraving}), it was explained that stem
directions influence spacing.  This is controlled with the
@code{stem-spacing-correction} property in the
@internalsref{NoteSpacing}, object.  These are generated for every
@internalsref{Voice} context.  The @code{StaffSpacing} object
(generated at @internalsref{Staff} context) contains the same property
for controlling the stem/bar line spacing.  The following example shows
these corrections, once with default settings, and once with
exaggerated corrections:

@lilypond[quote,raggedright]
{
  c'4 e''4 e'4 b'4 |
  b'4 e''4 b'4 e''4|
  \override Staff.NoteSpacing #'stem-spacing-correction = #1.5
  \override Staff.StaffSpacing #'stem-spacing-correction = #1.5
  c'4 e''4 e'4 b'4 |
  b'4 e''4 b'4 e''4|      
}
@end lilypond


@seealso

Internals: @internalsref{SpacingSpanner}, @internalsref{NoteSpacing},
@internalsref{StaffSpacing}, @internalsref{SeparationItem}, and
@internalsref{SeparatingGroupSpanner}.

@refbugs

Spacing is determined on a score wide basis.  If you have a score that
changes its character (measured in durations) halfway during the
score, the part containing the longer durations will be spaced too
widely.

There is no convenient mechanism to manually override spacing.  The
following work-around may be used to insert extra space into a score.
@example
 \once \override Score.SeparationItem #'padding = #1
@end example

No work-around exists for decreasing the amount of space.

@node Line length
@subsection Line length

@cindex page breaks
@cindex breaking pages

@cindex @code{indent}
@cindex @code{linewidth}

@c Although linewidth can be set in \layout, it should be set in paper
@c block, to get page layout right.
@c Setting indent in \paper block makes not much sense, but it works.

@c Bit verbose and vague, use examples?
The most basic settings influencing the spacing are @code{indent} and
@code{linewidth}.  They are set in the @code{\layout} block.  They
control the indentation of the first line of music, and the lengths of
the lines.

If @code{raggedright} is set to true in the @code{\layout} block, then
the lines are justified at their natural length.  This useful for
short fragments, and for checking how tight the natural spacing is.

@cindex page layout
@cindex vertical spacing

The option @code{raggedlast} is similar to @code{raggedright}, but
only affects the last line of the piece.  No restrictions are put on
that line.  The result is similar to formatting text paragraphs.  In a
paragraph, the last line simply takes its natural length.
@c Note that for text there are several options for the last line.
@c While Knuth TeX uses natural length, lead typesetters use the same
@c stretch as the previous line.  eTeX uses \lastlinefit to
@c interpolate between both these solutions.

@node Line breaking
@subsection Line breaking

@cindex line breaks
@cindex breaking lines

Line breaks are normally computed automatically.  They are chosen such
that lines look neither cramped nor loose, and that consecutive lines
have similar density.

Occasionally you might want to override the automatic breaks; you can
do this by specifying @code{\break}.  This will force a line break at
this point.  Line breaks can only occur at places where there are bar
lines.  If you want to have a line break where there is no bar line,
you can force an invisible bar line by entering @code{\bar
""}.  Similarly, @code{\noBreak} forbids a line break at a 
point.


@cindex regular line breaks
@cindex four bar music. 

For line breaks at regular intervals use @code{\break} separated by
skips and repeated with @code{\repeat}:
@example
<< \repeat unfold 7 @{
         s1 \noBreak s1 \noBreak
         s1 \noBreak s1 \break @}
   @emph{the real music}
>> 
@end example

@noindent
This makes the following 28 measures (assuming 4/4 time) be broken every
4 measures, and only there.

@refcommands

@code{\break}, and @code{\noBreak}.
@cindex @code{\break}
@cindex @code{\noBreak}

@seealso

Internals: @internalsref{BreakEvent}.



@node Multiple movements
@subsection Multiple movements

@cindex bibliographic information
@cindex titles
@cindex composer
@cindex Engraved by LilyPond

A document may contains multiple pieces of music.  Examples of these
are an etude book, or an orchestral part with multiple movements.
Each movement is entered with a @code{\score} block,

@example
\score @{
  @var{..music..}
@}
@end example

The movements are combined together to  
@code{\book} block is used to group the individual movements.

@example
\book @{
  \score @{
    @var{..}
  @}
  \score @{
    @var{..}
  @}
@}
@end example


The header for each piece of music can be put inside the @code{\score}
block.  The @code{piece} name from the header will be printed before
each movement.  The title for the entire book can be put inside the
@code{\book}, but if it is not present, the @code{\header} which is at
the top of the file is inserted.

@cindex Engraved by LilyPond
@cindex signature line

@example 
\book @{
  \header @{
    title = "Eight miniatures" 
    composer = "Igor Stravinsky"
  @}
  \score @{
    @dots{}
    \header @{ piece = "Romanze" @}
  @}
  \score @{
    @dots{}
    \header @{ piece = "Menuetto" @}
  @}
@}
@end example

@node Creating titles
@subsection Creating titles

Titles are created for each @code{\score} block, and over a
@code{\book}.

The contents of the titles are taken from the @code{\header} blocks.
The header block for a book supports the following 
@table @code
@item title
The title of the music.  Centered on top of the first page.

@item subtitle
Subtitle, centered below the title.

@item subsubtitle
Subsubtitle, centered below the subtitle.

@item poet
Name of the poet, left flushed below the subtitle.

@item composer
Name of the composer, right flushed below the subtitle.

@item meter
Meter string, left flushed below the poet.

@item opus
Name of the opus, right flushed below the composer.

@item arranger
Name of the arranger, right flushed below the opus.

@item instrument
Name of the instrument, centered below the arranger.

@item dedication            
To whom the piece is dedicated.

@item piece
Name of the piece, left flushed below the instrument.
@end table

This is a demonstration of the fields available, 

@lilypond[quote,verbatim,linewidth=11.0\cm]
\paper {
  linewidth = 11.0\cm
  vsize = 10.0\cm
}

\book {
  \header {
    title = "Title,"
    subtitle = "the subtitle,"
    subsubtitle = "and the sub sub title"
    poet = "Poet"
    composer = "Composer"
    texttranslator = "Text Translator"
    meter = "Meter"
    arranger = "Arranger"
    instrument = "Instrument"
    piece = "Piece"
  }

  \score {
    \header {
      piece = "piece1"
      opus = "opus1" 
    }
    { c'1 }
  }
  \score {
    \header {
      piece = "piece2"
      opus = "opus2" 
    }
    { c'1 }
  }
}
@end lilypond

Different fonts may be selected for each element, by using a
@code{\markup}, e.g.

@example
\header @{
  title = \markup @{ \italic @{ The italic title @} @}
@}
@end example

A more advanced option is to change the Scheme functions
@code{make-book-title} and @code{make-score-title} functions, defined
in the @code{\paper} of the @code{\book} block.  These functions
create a block of titling, given the information in the
@code{\header}.  The init file @file{ly/@/titling@/.scm} shows how the
default format is created, and it may be used as a template for
different styles.

 
@cindex \paper
@cindex header
@cindex footer
@cindex page layout
@cindex titles




@node Page breaking
@subsection Page breaking

The default page breaking may be overriden by inserting
@code{\pageBreak} or @code{\noPageBreak} commands.  These commands are
analogous to @code{\break} and @code{\noBreak}.  They should be
inserted with a bar line.  These commands force and forbid a page-break
from happening.  Of course, the @code{\pageBreak} command also forces
a line break.

Page breaks are computed by the @code{page-breaking} function in the
@code{\paper} block. 

@refcommands

@cindex @code{\pageBreak}
@code{\pageBreak}
@cindex @code{\noPageBreak} 
@code{\noPageBreak} 

@node Paper size
@subsection Paper size

@cindex paper size
@cindex page size
@cindex @code{papersize}

To change the paper size, there are two equal commands,
@example
#(set-default-paper-size "a4")
\paper @{
  #(set-paper-size "a4")
@}
@end example

The first command sets the size of all pages.  The second command sets the size of the pages that the @code{\paper} block applies to -- if the @code{\paper} block is at the top of the file, then it will apply to all pages.  If the @code{\paper} block is inside a @code{\score}, then the paper size will only apply to that score.

The following paper sizes are supported: @code{a6}, @code{a5}, @code{a4},
@code{a3}, @code{legal}, @code{letter}, @code{tabloid}.

@cindex orientation
@cindex landscape

If the symbol @code{landscape} is supplied as argument to
@code{set-default-paper-size}, the pages will be rotated 90 degrees,
and line widths will be set longer correspondingly.

@example
#(set-default-paper-size "a6" 'landscape)
@end example 

@node Page layout
@subsection Page layout

@cindex page layout
@cindex margins
@cindex header, page
@cindex footer, page

LilyPond will do page layout, setting margins and adding headers and
footers to each page.

The default layout responds to the following settings in the
@code{\paper} block.

@cindex \paper

@quotation
@table @code
@item firstpagenumber
The value of the page number of the first page.  Default is@tie{}1.

@item printfirstpagenumber
If set to true will print the page number in the first page.  Default is
false.

@item hsize
The width of the page.

@item vsize
The height of the page.

@item topmargin
Margin between header and top of the page.

@item bottommargin
Margin between footer and bottom of the page.

@item leftmargin
Margin between the left side of the page and the beginning of the music.

@item linewidth
The length of the systems.

@item headsep
Distance between top-most music system and the page header.

@item footsep
Distance between bottom-most music system and the page footer.

@item raggedbottom
If set to true, systems will not be spread across the page.

This should be set false for pieces that have only two or three
systems per page, for example orchestral scores.
 
@item raggedlastbottom
If set to false, systems will be spread to fill the last page.

Pieces that amply fill two pages or more should have this set to
true.

@item betweensystemspace
This dimensions determines the distance between systems.  It is the
ideal distance between the center of the bottom staff of one system,
and the center of the top staff of the next system.

Increasing this will provide a more even appearance of the page at the
cost of using more vertical space.

@item betweensystempadding
This dimension is the minimum amount of white space that will always
be present between the bottom most symbol of one system, and the
topmost of the next system.

Increasing this will put systems whose bounding boxes almost touch
farther apart.

@item aftertitlespace
Amount of space between title and the first system.

@item beforetitlespace 
Amount of space between last system of the previous piece and the
title of the next.

@item betweentitlespace
Amount of space between consecutive titles (e.g., the title of the
book and the title of piece).

@end table
@end quotation

Example:

@example
\paper@{
  hsize = 2\cm
  topmargin = 3\cm
  bottommargin = 3\cm
  raggedlastbottom = ##t
@}
@end example

You can also define these values in scheme.  In that case @code{mm},
@code{in}, @code{pt} and @code{cm} are variables defined in
@file{paper-defaults.ly} with values in millimeters.  That's why the
value has to be multiplied in the example above.

@example
\paper @{
  #(define bottommargin (* 2 cm)) 
@}
@end example

@cindex copyright
@cindex tagline

The default footer is empty, except for the first page, where it the
@code{copyright} field from @code{\header} is inserted, and the last
page, where @code{tagline} from @code{\header} is added.  The default
tagline is ``Engraved by LilyPond (@var{version})''.@footnote{Nicely
printed parts are good PR for us, so please leave the tagline if you
can.}

The header and footer are created by the functions @code{make-footer}
and @code{make-header}, defined in @code{\paper}.  The default
implementations are in @file{scm/@/page@/-layout@/.scm}.

The following settings influence the header and footer layout.

@quotation
@table @code
@item printpagenumber
  this boolean controls whether a pagenumber is printed. 
@end table
@end quotation

The page layout itself is done by two functions in the
@code{\paper}, @code{page-music-height} and
@code{page-make-stencil}.  The former tells the line-breaking algorithm
how much space can be spent on a page, the latter creates the actual
page given the system to put on it.


@seealso

Examples: @inputfileref{input/@/test,page@/-breaks@/.ly}

@refbugs

The option rightmargin is defined but doesn't set the right margin
yet.  The value for the right margin has to be defined adjusting the
values of the leftmargin and linewidth.

The default page header puts the page number and the @code{instrument}
field from the @code{\header} block on a line.



@node File structure
@section File structure

The bigger part of this manual is concerned with entering various
forms of music in LilyPond.  However, many music expressions are not
valid input on their own, for example, a @code{.ly} file containing
only a note
@example
c'4
@end example

@noindent
will result in a parsing error.  Instead, music should be inside other
expressions, which may be put in a file by themselves.  Such
expressions are called toplevel expressions.  This section enumerates
them all.

A @code{.ly} file contains any number of toplevel expressions, where a
toplevel expressions is one of the following

@itemize @bullet
@item
An output definition, such as @code{\paper}, @code{\midi}
and @code{\layout}.  Such a definition at toplevel changes the default
settings for the block entered.

@item
A @code{\header} block.  This sets the global header block.  This
is the block containing the definitions for book-wide settings, like
composer, title, etc. 

@item
An @code{\addquote} statement.  See @ref{Quoting other voices}
for more information.

@item
A @code{\score} block.  This score will be collected with other
toplevel scores, and combined as a single @code{\book}.

This behavior can be changed by setting the variable
@code{toplevel-score-handler} at toplevel.  The default handler is
defined in the init file @file{scm/@/lily@/.scm}.

@item
A @code{\book} block logically combines multiple movements
(i.e., multiple @code{\score} blocks) into one document.  A number of
@code{\scores} creates a single output file, where all movement are
concatenated..

This behavior can be changed by setting the variable
@code{toplevel-book-handler} at toplevel.  The default handler is
defined in the init file @file{scm/@/lily@/.scm}.

@item A compound music expression, such as
@example
@{ c'4 d' e'2 @}
@end example

This will add the piece in a @code{\score}, and formats it into a
single book together with all other toplevel @code{\score}s and music
expressions.
 
This behavior can be changed by setting the variable
@code{toplevel-music-handler} at toplevel.  The default handler is
defined in the init file @file{scm/@/lily@/.scm}.
 
@end itemize

The following example shows three things which may be entered at
toplevel

@example
\layout @{
  % movements are non-justified by default    
  raggedright = ##t
@}

\header @{
   title = "Do-re-mi"
@}
   
@{ c'4 d' e2 @}
@end example


At any point in a file, any of the following lexical instructions can
be entered:

@itemize @bullet
@item @code{\version}
@item @code{\include}
@item @code{\encoding}
@item @code{\renameinput}
@end itemize 

